<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KetoGo — Weekly Trustpilot Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      :root {
        --bg: #0f1724;
        --panel: #1a2332;
        --panel-light: #212b3d;
        --muted: #9aa4b2;
        --text: #e6eef6;
        --accent: #00b67a;
        --danger: #ff5b57;
        --warning: #f59e0b;
        --info: #3b82f6;
        --glass: rgba(255, 255, 255, 0.04);
        --glass-border: rgba(255, 255, 255, 0.06);
        --card-radius: 12px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        min-height: 100vh;
        background: linear-gradient(
          135deg,
          #0a1628 0%,
          #0f1b2e 50%,
          #1a1f2e 100%
        );
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        padding: 20px;
        line-height: 1.5;
        font-size: 14px;
      }

      .icon {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .icon-sm {
        width: 16px;
        height: 16px;
      }
      .icon-lg {
        width: 20px;
        height: 20px;
      }

      .wrap {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header,
      .panel {
        background: linear-gradient(
          135deg,
          var(--panel) 0%,
          var(--panel-light) 100%
        );
        padding: 20px 24px;
        border-radius: var(--card-radius);
        margin-bottom: 16px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .panel {
        padding: 18px;
        margin: 10px 0;
      }

      .header-row,
      .brand,
      .meta {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }

      .header-row {
        justify-content: space-between;
      }
      .brand {
        gap: 14px;
      }
      .meta {
        font-size: 13px;
        color: var(--muted);
        gap: 16px;
      }
      .meta strong {
        color: var(--text);
      }
      .meta .icon {
        width: 14px;
        height: 14px;
        margin-right: 4px;
        vertical-align: middle;
      }

      .logo {
        width: 64px;
        height: 64px;
        border-radius: 12px;
        background: #fff;
        padding: 8px;
        display: grid;
        place-items: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .brand-info h1 {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: -0.3px;
        margin-bottom: 6px;
        background: linear-gradient(135deg, #fff 0%, var(--muted) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-stats,
      .kpis {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .kpis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .stat-pill,
      .kpi {
        background: var(--glass);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 10px 16px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .stat-pill {
        min-width: 140px;
        padding: 10px 16px;
      }
      .kpi {
        padding: 14px;
        transition: all 0.2s ease;
      }
      .kpi:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      .stat-pill.highlight {
        background: linear-gradient(
          135deg,
          rgba(0, 182, 122, 0.15),
          rgba(0, 182, 122, 0.05)
        );
        border-color: rgba(0, 182, 122, 0.3);
      }

      .label {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .kpi .label {
        margin-bottom: 8px;
        font-weight: 700;
      }

      .value,
      .stat-pill .value {
        font-size: 20px;
        font-weight: 700;
        line-height: 1;
      }

      .kpi .value {
        font-size: 28px;
        margin-bottom: 6px;
      }

      .stat-pill .sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }

      .delta {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .positive {
        color: var(--accent);
      }
      .negative {
        color: var(--danger);
      }
      .neutral {
        color: var(--muted);
      }

      .panel-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--glass-border);
      }
      .panel-title .icon {
        color: var(--accent);
      }

      .charts,
      .mentions-grid {
        display: grid;
        gap: 14px;
        margin-top: 14px;
      }

      .charts {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .mentions-grid {
        grid-template-columns: 1fr 1fr;
      }

      .chart-card,
      .mention-box {
        background: var(--glass);
        padding: 16px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .mention-box {
        padding: 14px;
      }

      .chart-title,
      .mention-box-title {
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .chart-title {
        color: var(--text);
        margin-bottom: 12px;
      }
      .mention-box-title {
        margin-bottom: 10px;
      }
      .chart-title .icon,
      .mention-box-title .icon {
        width: 16px;
        height: 16px;
      }
      .chart-title .icon {
        color: var(--accent);
      }
      .mention-box-title.positive {
        color: var(--accent);
      }
      .mention-box-title.negative {
        color: var(--danger);
      }

      .chart-canvas {
        height: 200px;
        margin-bottom: 12px;
      }

      .sentiment-bars {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .sentiment-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .sentiment-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: var(--muted);
      }
      .sentiment-row strong {
        color: var(--text);
      }

      .track {
        height: 10px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 999px;
        overflow: hidden;
      }

      .bar {
        height: 100%;
        border-radius: 999px;
        transition: width 0.4s ease;
      }
      .bar.pos {
        background: linear-gradient(90deg, #059669, #00b67a);
      }
      .bar.neu {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
      }
      .bar.neg {
        background: linear-gradient(90deg, #ff5b57, #ff7b72);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 10px;
      }

      th,
      td {
        padding: 10px 12px;
        text-align: left;
      }

      thead th {
        color: var(--muted);
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--glass-border);
      }

      tbody tr {
        border-top: 1px solid rgba(255, 255, 255, 0.03);
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      td {
        color: var(--text);
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .badge-organic {
        background: rgba(59, 130, 246, 0.15);
        color: #93c5fd;
      }
      .badge-verified {
        background: rgba(5, 150, 105, 0.15);
        color: #6ee7b7;
      }
      .badge-invited {
        background: rgba(245, 158, 11, 0.15);
        color: #fcd34d;
      }

      .summary-box {
        background: var(--glass);
        padding: 16px;
        border-radius: 10px;
        border-left: 3px solid var(--accent);
        font-size: 13px;
        line-height: 1.7;
        color: var(--muted);
        margin-top: 12px;
      }

      .summary-meta {
        font-size: 11px;
        color: #64748b;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .summary-meta .icon {
        width: 12px;
        height: 12px;
      }

      .highlights {
        background: linear-gradient(
          135deg,
          rgba(0, 182, 122, 0.12),
          rgba(0, 182, 122, 0.03)
        );
        border: 1px solid rgba(0, 182, 122, 0.2);
        padding: 16px;
        border-radius: 10px;
        margin-bottom: 14px;
      }

      .highlights-title {
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 10px;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .highlights-title .icon {
        width: 18px;
        height: 18px;
      }

      .highlights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
        font-size: 13px;
        line-height: 1.6;
      }

      .highlights-grid div {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .highlights-grid .icon {
        flex-shrink: 0;
        color: var(--accent);
      }
      .highlights-grid div span {
        flex: 1;
      }

      .mention-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .mention-tag {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .mention-tag .icon {
        width: 12px;
        height: 12px;
      }
      .mention-tag.positive {
        border-color: rgba(0, 182, 122, 0.3);
        background: rgba(0, 182, 122, 0.08);
      }
      .mention-tag.negative {
        border-color: rgba(255, 91, 87, 0.3);
        background: rgba(255, 91, 87, 0.08);
      }

      .no-data {
        color: var(--muted);
        font-size: 13px;
        font-style: italic;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        font-size: 16px;
        color: var(--muted);
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-right: 12px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 1200px) {
        .header-row {
          flex-direction: column;
        }
        .charts {
          grid-template-columns: 1fr;
        }
        .kpis {
          grid-template-columns: repeat(2, 1fr);
        }
        .mentions-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 600px) {
        body {
          padding: 12px;
        }
        .header,
        .panel {
          padding: 16px;
        }
        .brand {
          flex-direction: column;
          text-align: center;
        }
        .brand-info h1 {
          font-size: 18px;
        }
        .kpis {
          grid-template-columns: 1fr;
        }
        .stat-pill {
          min-width: auto;
        }
        .highlights-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>Loading report data...</div>
      </div>

      <main id="report" hidden>
        <div id="header"></div>
        <div id="highlights"></div>

        <div class="panel">
          <div class="panel-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
            Week-over-Week Performance
          </div>
          <div id="kpis" class="kpis"></div>
        </div>

        <div class="panel">
          <div class="charts">
            <div class="chart-card">
              <div class="chart-title">
                <svg class="icon" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                  <line x1="9" y1="9" x2="9.01" y2="9" />
                  <line x1="15" y1="9" x2="15.01" y2="9" />
                </svg>
                Sentiment Breakdown (Current Week)
              </div>
              <div class="chart-canvas">
                <canvas id="sentimentChart"></canvas>
              </div>
              <div id="sentimentBars" class="sentiment-bars"></div>
            </div>

            <div class="chart-card">
              <div class="chart-title">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                  <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
                Review Sources
              </div>
              <div class="chart-canvas">
                <canvas id="sourcesChart"></canvas>
              </div>
              <table id="sourcesTable"></table>
            </div>

            <div class="chart-card">
              <div class="chart-title">
                <svg class="icon" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="2" y1="12" x2="22" y2="12" />
                  <path
                    d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
                  />
                </svg>
                Language Distribution
              </div>
              <div class="chart-canvas">
                <canvas id="languageChart"></canvas>
              </div>
              <table id="languageTable"></table>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              />
            </svg>
            Top Mentions & Keywords (Current Week)
          </div>
          <div id="mentions" class="mentions-grid"></div>
        </div>

        <div class="panel">
          <div class="panel-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
            AI-Generated Insights (Overall sentiment analysis)
          </div>
          <div id="aiSummary" class="summary-box"></div>
        </div>
      </main>
    </div>

    <script>
      const EMBEDDED_DATA = null;

      const Icons = {
        calendar:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
        star: '<svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        clock:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        trendingUp:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
        trendingDown:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>',
        checkCircle:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        xCircle:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        edit: '<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
        tag: '<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
        thumbsUp:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>',
        thumbsDown:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>',
        refresh:
          '<svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
      };

      const formatDate = (dateStr) =>
        new Date(dateStr).toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });

      const formatDateTime = (dateStr) =>
        new Date(dateStr).toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

      const getWeekRange = () => {
        const end = new Date();
        const start = new Date(end);
        start.setDate(end.getDate() - 7);
        return {
          start: start.toISOString().split("T")[0],
          end: end.toISOString().split("T")[0],
        };
      };

      const filterReviewsByDateRange = (
        reviews,
        startDate,
        endDate,
        dateField = "publishedDate"
      ) => {
        const start = new Date(startDate);
        const end = new Date(endDate);
        return reviews.filter((r) => {
          const date = new Date(r.dates[dateField]);
          return date >= start && date <= end;
        });
      };

      const calculateSentiment = (reviews) => {
        const sentiment = { positive: 0, neutral: 0, negative: 0 };
        reviews.forEach((r) => {
          if (r.rating >= 4) sentiment.positive++;
          else if (r.rating === 3) sentiment.neutral++;
          else sentiment.negative++;
        });
        return sentiment;
      };

      const groupByField = (reviews, field) => {
        return reviews.reduce((acc, review) => {
          const key = review[field] || "unknown";
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});
      };

      const calculateAverage = (reviews, field) => {
        if (!reviews.length) return 0;
        return reviews.reduce((sum, r) => sum + r[field], 0) / reviews.length;
      };

      const analyzeReviews = (reviews) => {
        const weekRange = getWeekRange();
        const prevWeekStart = new Date(weekRange.start);
        prevWeekStart.setDate(prevWeekStart.getDate() - 7);

        const currentWeekReviews = filterReviewsByDateRange(
          reviews,
          weekRange.start,
          weekRange.end
        );
        const prevWeekReviews = filterReviewsByDateRange(
          reviews,
          prevWeekStart.toISOString().split("T")[0],
          weekRange.start
        );

        const updatedThisWeek = reviews.filter((r) => {
          if (!r.dates.updatedDate) return false;
          const updateDate = new Date(r.dates.updatedDate);
          const publishDate = new Date(r.dates.publishedDate);
          const wasNewThisWeek =
            publishDate >= new Date(weekRange.start) &&
            publishDate <= new Date(weekRange.end);
          return (
            updateDate >= new Date(weekRange.start) &&
            updateDate <= new Date(weekRange.end) &&
            !wasNewThisWeek
          );
        });

        const prevUpdatedReviews = reviews.filter((r) => {
          if (!r.dates.updatedDate) return false;
          const updateDate = new Date(r.dates.updatedDate);
          const publishDate = new Date(r.dates.publishedDate);
          const wasNewPrevWeek =
            publishDate >= prevWeekStart &&
            publishDate < new Date(weekRange.start);
          return (
            updateDate >= prevWeekStart &&
            updateDate < new Date(weekRange.start) &&
            !wasNewPrevWeek
          );
        });

        const languages = groupByField(currentWeekReviews, "language");
        Object.keys(languages).forEach((key) => {
          const upperKey = (key || "unknown").toUpperCase();
          if (upperKey !== key) {
            languages[upperKey] = languages[key];
            delete languages[key];
          }
        });

        const sources = { organic: 0, verified: 0, invited: 0 };
        currentWeekReviews.forEach((r) => {
          if (r.labels?.verification?.isVerified) sources.verified++;
          else if ((r.source || "").toLowerCase() === "invited")
            sources.invited++;
          else sources.organic++;
        });

        const reviewsWithReplies = currentWeekReviews.filter((r) => r.reply);
        const avgResponseTime = reviewsWithReplies.length
          ? reviewsWithReplies.reduce((sum, r) => {
              const diffDays =
                (new Date(r.reply.publishedDate) -
                  new Date(r.dates.publishedDate)) /
                (1000 * 60 * 60 * 24);
              return sum + diffDays;
            }, 0) / reviewsWithReplies.length
          : 0;

        return {
          current: {
            count: currentWeekReviews.length,
            updatedCount: updatedThisWeek.length,
            avgRating: calculateAverage(currentWeekReviews, "rating"),
            sentiment: calculateSentiment(currentWeekReviews),
            languages,
            sources,
            responseRate: currentWeekReviews.length
              ? (reviewsWithReplies.length / currentWeekReviews.length) * 100
              : 0,
            repliedCount: reviewsWithReplies.length,
            avgResponseTime,
            reviews: currentWeekReviews,
          },
          previous: {
            count: prevWeekReviews.length,
            updatedCount: prevUpdatedReviews.length,
            avgRating: calculateAverage(prevWeekReviews, "rating"),
          },
          weekRange,
        };
      };

      const analyzeTopMentions = (reviews, topMentions = []) => {
        if (!topMentions.length || !reviews.length) {
          return { positive: [], negative: [], neutral: [] };
        }

        const topicSentiment = {};

        topMentions.forEach((topic) => {
          topicSentiment[topic] = {
            positive: 0,
            negative: 0,
            neutral: 0,
            total: 0,
          };
          const topicWords = topic.toLowerCase().split(" ");

          reviews.forEach((review) => {
            const searchText = `${review.text || ""} ${
              review.title || ""
            }`.toLowerCase();
            if (topicWords.some((word) => searchText.includes(word))) {
              topicSentiment[topic].total++;
              if (review.rating >= 4) topicSentiment[topic].positive++;
              else if (review.rating === 3) topicSentiment[topic].neutral++;
              else topicSentiment[topic].negative++;
            }
          });
        });

        const categorized = { positive: [], negative: [], neutral: [] };

        Object.entries(topicSentiment).forEach(([topic, sentiment]) => {
          if (sentiment.total === 0) return;
          const negRatio = sentiment.negative / sentiment.total;
          const posRatio = sentiment.positive / sentiment.total;
          if (negRatio > 0.6) categorized.negative.push(topic);
          else if (posRatio > 0.6) categorized.positive.push(topic);
          else categorized.neutral.push(topic);
        });

        return categorized;
      };

      const calculateChange = (current, previous) => {
        const change = current - previous;
        const pct = previous > 0 ? ((change / previous) * 100).toFixed(1) : "0";
        return { change, pct };
      };

      const renderTrendIcon = (change) =>
        change >= 0 ? Icons.trendingUp : Icons.trendingDown;

      const renderHeader = (data, analytics) => {
        const { company } = data;
        const { weekRange, current, previous } = analytics;
        const reviewChange = calculateChange(current.count, previous.count);

        return `
          <div class="header">
            <div class="header-row">
              <div class="brand">
                <div class="logo">
                  <img src="${company.logo_url}" alt="${
          company.brand_name
        } logo">
                </div>
                <div class="brand-info">
                  <h1>${company.brand_name} — Weekly Trustpilot Report</h1>
                  <div class="meta">
                    <span>${
                      Icons.calendar
                    }<strong>Period:</strong> ${formatDate(
          weekRange.start
        )} → ${formatDate(weekRange.end)}</span>
                    <span>${
                      Icons.clock
                    }<strong>Generated:</strong> ${formatDate(
          new Date().toISOString()
        )}</span>
                  </div>
                </div>
              </div>
              <div class="header-stats">
                <div class="stat-pill">
                  <div class="label">Trust Score</div>
                  <div class="value">${company.trust_score}/5</div>
                  <div class="sub">Overall rating</div>
                </div>
                <div class="stat-pill">
                  <div class="label">Total Reviews</div>
                  <div class="value">${company.total_reviews.toLocaleString()}</div>
                  <div class="sub">All-time</div>
                </div>
                <div class="stat-pill highlight">
                  <div class="label">New Reviews</div>
                  <div class="value">${current.count}</div>
                  <div class="sub" style="color:${
                    reviewChange.change >= 0 ? "var(--accent)" : "var(--danger)"
                  }">
                    ${renderTrendIcon(reviewChange.change)} ${
          reviewChange.change >= 0 ? "+" : ""
        }${reviewChange.pct}% vs last week
                  </div>
                </div>
              </div>
            </div>
          </div>`;
      };

      const renderHighlights = (analytics) => {
        const { current, previous } = analytics;
        const reviewChange = calculateChange(current.count, previous.count);
        const updatedChange = calculateChange(
          current.updatedCount,
          previous.updatedCount
        );
        const ratingChange = current.avgRating - previous.avgRating;

        return `
          <div class="highlights">
            <div class="highlights-title">
              <svg class="icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
              Weekly Highlights
            </div>
            <div class="highlights-grid">
              <div>${Icons.edit}<span><strong>${
          current.count
        } new reviews</strong> this week 
                <span style="color:${
                  reviewChange.change >= 0 ? "var(--accent)" : "var(--danger)"
                }">
                  ${reviewChange.change >= 0 ? "↑" : "↓"} ${Math.abs(
          reviewChange.pct
        )}%
                </span></span>
              </div>
              <div>${Icons.refresh}<span><strong>${
          current.updatedCount
        } reviews updated</strong> this week
                <span style="color:${
                  updatedChange.change >= 0 ? "var(--accent)" : "var(--danger)"
                }">
                  ${updatedChange.change >= 0 ? "↑" : "↓"} ${Math.abs(
          updatedChange.pct
        )}%
                </span></span>
              </div>
              <div>${
                Icons.star
              }<span><strong>Avg rating:</strong> ${current.avgRating.toFixed(
          2
        )}
                <span style="color:${
                  ratingChange >= 0 ? "var(--accent)" : "var(--danger)"
                }">
                  (${ratingChange >= 0 ? "+" : ""}${ratingChange.toFixed(2)})
                </span></span>
              </div>
              <div>${
                Icons.clock
              }<span><strong>Response rate:</strong> ${current.responseRate.toFixed(
          1
        )}% — ${current.repliedCount} replies</span></div>
              <div>${
                Icons.clock
              }<span><strong>Avg response time:</strong> ${current.avgResponseTime.toFixed(
          1
        )} days</span></div>
            </div>
          </div>`;
      };

      const renderKPIs = (analytics) => {
        const { current, previous } = analytics;
        const reviewChange = calculateChange(current.count, previous.count);
        const updatedChange = calculateChange(
          current.updatedCount,
          previous.updatedCount
        );
        const ratingChange = current.avgRating - previous.avgRating;
        const ratingChangePct =
          previous.avgRating > 0
            ? ((ratingChange / previous.avgRating) * 100).toFixed(1)
            : "0";

        const kpiData = [
          { label: "New Reviews", value: current.count, ...reviewChange },
          {
            label: "Updated Reviews",
            value: current.updatedCount,
            ...updatedChange,
          },
          {
            label: "Avg Rating",
            value: current.avgRating.toFixed(2),
            change: ratingChange.toFixed(2),
            pct: ratingChangePct,
          },
          {
            label: "Response Rate",
            value: `${current.responseRate.toFixed(1)}%`,
            change: 0,
            sub: `${current.repliedCount} of ${current.count}`,
            icon: Icons.checkCircle,
          },
          {
            label: "Avg Response Time",
            value: current.avgResponseTime.toFixed(1),
            change: 0,
            sub: "days",
            icon: Icons.clock,
          },
        ];

        return kpiData
          .map(
            (kpi) => `
          <div class="kpi">
            <div class="label">${kpi.label}</div>
            <div class="value">${kpi.value}</div>
            <div class="delta ${
              kpi.change > 0
                ? "positive"
                : kpi.change < 0
                ? "negative"
                : "neutral"
            }">
              ${kpi.icon || renderTrendIcon(kpi.change)}
              <span>${
                kpi.sub ||
                `${Math.abs(kpi.change)} (${kpi.change >= 0 ? "+" : ""}${
                  kpi.pct
                }%)`
              }</span>
            </div>
          </div>`
          )
          .join("");
      };

      const renderSentimentBars = (sentiment, total) => {
        const calcPct = (count) => (total > 0 ? (count / total) * 100 : 0);
        const bars = [
          { type: "Positive (4-5 ★)", count: sentiment.positive, class: "pos" },
          { type: "Neutral (3 ★)", count: sentiment.neutral, class: "neu" },
          { type: "Negative (1-2 ★)", count: sentiment.negative, class: "neg" },
        ];

        return bars
          .map((bar) => {
            const pct = calcPct(bar.count);
            return `
            <div class="sentiment-item">
              <div class="sentiment-row">
                <strong>${bar.type}</strong>
                <span>${bar.count} reviews (${pct.toFixed(1)}%)</span>
              </div>
              <div class="track">
                <div class="bar ${bar.class}" style="width:${pct}%"></div>
              </div>
            </div>`;
          })
          .join("");
      };

      const renderTable = (headers, rows) => `
        <thead><tr>${headers
          .map(
            (h) =>
              `<th${h.align ? ` style="text-align:${h.align}"` : ""}>${
                h.text
              }</th>`
          )
          .join("")}</tr></thead>
        <tbody>${rows
          .map(
            (row) =>
              `<tr>${row
                .map(
                  (cell, i) =>
                    `<td${
                      headers[i].align
                        ? ` style="text-align:${headers[i].align}"`
                        : ""
                    }>${cell}</td>`
                )
                .join("")}</tr>`
          )
          .join("")}</tbody>`;

      const renderSourcesTable = (sources) => {
        const total = sources.organic + sources.verified + sources.invited;
        const calcPct = (count) =>
          total > 0 ? ((count / total) * 100).toFixed(1) : "0";

        const rows = [
          [
            `<span class="badge badge-organic">Organic</span>`,
            sources.organic,
            `${calcPct(sources.organic)}%`,
          ],
          [
            `<span class="badge badge-verified">Verified</span>`,
            sources.verified,
            `${calcPct(sources.verified)}%`,
          ],
        ];

        if (sources.invited > 0) {
          rows.push([
            `<span class="badge badge-invited">Invited</span>`,
            sources.invited,
            `${calcPct(sources.invited)}%`,
          ]);
        }

        return renderTable(
          [
            { text: "Type" },
            { text: "Count", align: "right" },
            { text: "%", align: "right" },
          ],
          rows
        );
      };

      const renderLanguageTable = (languages) => {
        const total = Object.values(languages).reduce((a, b) => a + b, 0);
        const sorted = Object.entries(languages)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        const rows = sorted.map(([lang, count]) => [
          lang,
          `<strong>${count}</strong>`,
          `${((count / total) * 100).toFixed(1)}%`,
        ]);

        return renderTable(
          [
            { text: "Language" },
            { text: "Reviews", align: "right" },
            { text: "%", align: "right" },
          ],
          rows
        );
      };

      const renderTopMentions = (mentions) => {
        const hasData =
          mentions.positive?.length ||
          mentions.negative?.length ||
          mentions.neutral?.length;

        if (!hasData) {
          return `<div class="mention-box" style="grid-column: 1 / -1">
            <div class="no-data">No Trustpilot topics were mentioned in this week's reviews</div>
          </div>`;
        }

        const renderMentionBox = (title, items, className) => `
          <div class="mention-box">
            <div class="mention-box-title ${className}">
              ${
                className === "positive"
                  ? Icons.thumbsUp
                  : className === "negative"
                  ? Icons.thumbsDown
                  : Icons.tag
              }
              ${title}
              ${
                items?.length
                  ? `<span style="font-size:11px;font-weight:400;color:var(--muted);margin-left:auto">${items.length} mentioned</span>`
                  : ""
              }
            </div>
            ${
              items?.length
                ? `<div class="mention-list">${items
                    .map(
                      (tag) =>
                        `<div class="mention-tag ${className}">${
                          className === "positive"
                            ? Icons.checkCircle
                            : className === "negative"
                            ? Icons.xCircle
                            : Icons.tag
                        }${tag}</div>`
                    )
                    .join("")}</div>`
                : '<div class="no-data">No ' +
                  title.toLowerCase() +
                  " mentioned this week</div>"
            }
          </div>`;

        let html = renderMentionBox(
          "Positive Topics",
          mentions.positive,
          "positive"
        );
        html += renderMentionBox(
          "Negative Topics",
          mentions.negative,
          "negative"
        );

        if (mentions.neutral?.length) {
          html += `<div class="mention-box" style="grid-column: 1 / -1">
            <div class="mention-box-title" style="color:var(--warning)">
              ${Icons.tag} Neutral Topics
              <span style="font-size:11px;font-weight:400;color:var(--muted);margin-left:auto">${
                mentions.neutral.length
              } mentioned</span>
            </div>
            <div class="mention-list">
              ${mentions.neutral
                .map(
                  (tag) =>
                    `<div class="mention-tag" style="border-color:rgba(245,158,11,0.3);background:rgba(245,158,11,0.08)">${Icons.tag}${tag}</div>`
                )
                .join("")}
            </div>
          </div>`;
        }

        return html;
      };

      const renderAISummary = (summary) => {
        if (!summary)
          return '<p style="color:var(--muted)">No AI summary available for this reporting period.</p>';
        return `<p>${summary.summary}</p>
          <div class="summary-meta">${Icons.clock}Generated: ${formatDateTime(
          summary.updated_at
        )} | Model: ${summary.model_version || "N/A"}</div>`;
      };

      const createChart = (ctx, type, labels, data, colors) => {
        const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip:
              type === "pie"
                ? {
                    callbacks: {
                      label: (context) => {
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce(
                          (a, b) => a + b,
                          0
                        );
                        const pct =
                          total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${context.label}: ${value} (${pct}%)`;
                      },
                    },
                  }
                : {},
          },
        };

        if (type === "pie") {
          return new Chart(ctx, {
            type: "pie",
            data: {
              labels,
              datasets: [
                {
                  data,
                  backgroundColor: colors,
                  borderColor: "#0f1724",
                  borderWidth: 2,
                },
              ],
            },
            options: commonOptions,
          });
        }

        return new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                data,
                backgroundColor: "rgba(0, 182, 122, 0.8)",
                borderColor: "#00b67a",
                borderWidth: 1,
                borderRadius: 6,
              },
            ],
          },
          options: {
            ...commonOptions,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1, color: "#9aa4b2", font: { size: 11 } },
                grid: { color: "rgba(255,255,255,0.05)" },
              },
              x: {
                ticks: { color: "#9aa4b2", font: { size: 11 } },
                grid: { display: false },
              },
            },
          },
        });
      };

      const loadAndRender = async () => {
        try {
          const data =
            EMBEDDED_DATA ||
            (await fetch("trustpilot_raw_data.json").then((r) => {
              if (!r.ok) throw new Error("Failed to load data file");
              return r.json();
            }));

          const analytics = analyzeReviews(data.reviews);
          const mentions = analyzeTopMentions(
            analytics.current.reviews,
            data.company.top_mentions || []
          );

          document.getElementById("header").innerHTML = renderHeader(
            data,
            analytics
          );
          document.getElementById("highlights").innerHTML =
            renderHighlights(analytics);
          document.getElementById("kpis").innerHTML = renderKPIs(analytics);
          document.getElementById("sentimentBars").innerHTML =
            renderSentimentBars(
              analytics.current.sentiment,
              analytics.current.count
            );
          document.getElementById("sourcesTable").innerHTML =
            renderSourcesTable(analytics.current.sources);
          document.getElementById("languageTable").innerHTML =
            renderLanguageTable(analytics.current.languages);
          document.getElementById("mentions").innerHTML =
            renderTopMentions(mentions);
          document.getElementById("aiSummary").innerHTML = renderAISummary(
            data.company.ai_summary
          );

          createChart(
            document.getElementById("sentimentChart").getContext("2d"),
            "pie",
            ["Positive (4-5★)", "Neutral (3★)", "Negative (1-2★)"],
            [
              analytics.current.sentiment.positive,
              analytics.current.sentiment.neutral,
              analytics.current.sentiment.negative,
            ],
            ["#059669", "#f59e0b", "#ff5b57"]
          );

          createChart(
            document.getElementById("sourcesChart").getContext("2d"),
            "pie",
            ["Organic", "Verified", "Invited"],
            [
              analytics.current.sources.organic,
              analytics.current.sources.verified,
              analytics.current.sources.invited,
            ],
            ["#3b82f6", "#059669", "#f59e0b"]
          );

          const langData = Object.entries(analytics.current.languages).sort(
            (a, b) => b[1] - a[1]
          );
          createChart(
            document.getElementById("languageChart").getContext("2d"),
            "bar",
            langData.map(([lang]) => lang),
            langData.map(([, count]) => count)
          );

          loading.remove();
          report.hidden = false;
        } catch (error) {
          console.error("Error loading report:", error);
          document.getElementById("loading").innerHTML = `
            <div style="text-align:center;color:var(--danger)">
              <h2>Error Loading Report</h2>
              <p>${error.message}</p>
              <p style="color:var(--muted);margin-top:10px">
                Make sure 'trustpilot_raw_data.json' is in the same directory,<br>
                or embed the data directly in the EMBEDDED_DATA variable.
              </p>
            </div>`;
        }
      };

      document.addEventListener("DOMContentLoaded", loadAndRender);
    </script>
  </body>
</html>
